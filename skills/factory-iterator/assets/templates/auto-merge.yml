name: {{AGENT_NAME}} Auto-Merge

# âš ï¸ TECH-STACK-PLACEHOLDER: ä»¥ä¸‹ CI æ­¥é©Ÿé è¨­ç‚º Java/Maven + NPMã€‚
# Initiator å¿…é ˆæ ¹æ“šå°ˆæ¡ˆé¸å‹æ›¿æ› "Backend Tests" èˆ‡ "Frontend Checks" ä¸­çš„å…§å®¹ã€‚
# è‹¥æœªé€²è¡ŒæŒ‡ä»¤æ›¿æ›å³éƒ¨ç½²ï¼Œé Java å°ˆæ¡ˆåœ¨ Phase 2 èµ·å°‡å› æ‰¾ä¸åˆ° pom.xml è€Œå…¨ç·šå¤±æ•—ã€‚

on:
  pull_request:
    types: [labeled, synchronize, reopened, ready_for_review]
    branches:
      - '{{BASE_BRANCH}}'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # ğŸ•µï¸ å®‰å…¨é–€æˆ¶ (Security Gates: Identity Lockdown)
    # åƒ…é™ BOT_USERNAME è§¸ç™¼ ä¸” å…·å‚™ auto-merge Label
    if: |
      github.event.pull_request.user.login == '{{BOT_USERNAME}}' &&
      contains(github.event.pull_request.labels.*.name, 'auto-merge')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # ğŸ›¡ï¸ Scaffolding Guard: ç¢ºä¿æ—©æœŸ PR ä¸è¢«éœé»˜åˆä½µ
      - name: Basic Factory Audit
        run: |
          if [ ! -f ".{{AGENT_NAME}}/tracker.json" ]; then
            echo "Error: Factory structure not found. Blocking merge."
            exit 1
          fi
          echo "Factory structure verified."

      # ğŸ›¡ï¸ Task Status Guard: é˜²æ­¢ Worker æ¼æ›´æ–° tracker å°±æ PR
      - name: Verify Task Completion in Tracker
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          TASK_ID=$(echo "$BRANCH_NAME" | grep -oP 'task-\K.*' || echo "")
          if [ -z "$TASK_ID" ]; then
            echo "Warning: Could not extract task ID from branch '$BRANCH_NAME'. Skipping check."
          else
            TASK_STATUS=$(jq -r --arg tid "task_${TASK_ID}" '.phases[].tasks[] | select(.id == $tid) | .status' .{{AGENT_NAME}}/tracker.json 2>/dev/null || echo "not_found")
            if [ "$TASK_STATUS" != "completed" ]; then
              echo "Error: Task '${TASK_ID}' status is '${TASK_STATUS}', expected 'completed'. Worker must update tracker before PR can merge."
              exit 1
            fi
            echo "Task '${TASK_ID}' status verified as 'completed'."
          fi

      # CI: å‹•æ…‹åµæ¸¬é˜²è­·æ©Ÿåˆ¶
      - name: Backend Tests (Maven)
        run: |
          CURRENT_PHASE=$(jq -r '.current_phase' .{{AGENT_NAME}}/tracker.json)
          if [ -f "./pom.xml" ]; then
            ./mvnw clean test
          elif [ -f "backend/pom.xml" ]; then
            cd backend && ./mvnw clean test
          else
            if [[ "$CURRENT_PHASE" != "Phase 1: Setup" ]]; then
              echo "Error: Backend missing after Phase 1. Failing CI."
              exit 1
            fi
            echo "Phase 1: Backend not initialized yet. Skipping."
          fi

      - name: Frontend Checks (NPM)
        run: |
          CURRENT_PHASE=$(jq -r '.current_phase' .{{AGENT_NAME}}/tracker.json)
          if [ -f "./package.json" ]; then
            npm ci && npm run build
          elif [ -f "frontend/package.json" ]; then
            cd frontend && npm ci && npm run build
          else
            if [[ "$CURRENT_PHASE" != "Phase 1: Setup" ]]; then
              echo "Error: Frontend missing after Phase 1. Failing CI."
              exit 1
            fi
            echo "Phase 1: Frontend not initialized yet. Skipping."
          fi

      - name: Auto-merge PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
          # âš ï¸ ACTION REQUIRED: GITHUB_TOKEN é€šå¸¸ç„¡æ¬Šé™åŸ·è¡Œ auto-merge æˆ–ç¹éåˆ†æ”¯ä¿è­·ã€‚
          # è«‹è‡³ GitHub Repo â†’ Settings â†’ Secrets â†’ Actions æ–°å¢ PAT_TOKENã€‚
          # PAT éœ€è¦çš„æ¬Šé™ï¼šrepo (full), workflowã€‚
          # è¨­å®šå®Œæˆå¾Œï¼Œè«‹ç¢ºä¿æ­¤è™•ä½¿ç”¨çš„æ˜¯ PAT_TOKENã€‚
          token: ${{ secrets.PAT_TOKEN }}
