name: {{AGENT_NAME}} Task Arbitrator (Cleanup)

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ™‚åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch: # æ”¯æ´æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup-stale-tasks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Main
        uses: actions/checkout@v4
        with:
          ref: {{BASE_BRANCH}}
          token: ${{ secrets.PAT_TOKEN }}

      - name: Detect Stale Branches and Increment Attempts
        shell: bash
        run: |
          # å–å¾—æ‰€æœ‰ä»¥ {{AGENT_NAME}}/task- é–‹é ­çš„é ç«¯åˆ†æ”¯
          branches=$(git branch -r | grep "origin/{{AGENT_NAME}}/task-" | sed 's/origin\///')
          
          for branch in $branches; do
            task_id=$(echo $branch | sed 's/{{AGENT_NAME}}\/task-//')
            echo "ğŸ•µï¸ Analyzing task: $task_id"
            
            # æª¢æŸ¥æ˜¯å¦å­˜åœ¨å°æ‡‰çš„ Open PR
            pr_status=$(gh pr list --head "$branch" --json state --jq '.[0].state' 2>/dev/null)
            
            # [é‚è¼¯]ï¼šå¦‚æœ PR å·²ç¶“ CLOSED/MERGEDï¼Œæˆ–è€…åˆ†æ”¯å·²å­˜åœ¨è¶…é 24 å°æ™‚ä¸”ç„¡ PR
            # æ­¤è™•ä»¥ã€ŒPR å·²é—œé–‰ä½†åˆ†æ”¯æ®˜ç•™ã€ä½œç‚ºè¨ˆæ•¸é»
            if [[ "$pr_status" == "CLOSED" ]]; then
              echo "âš ï¸ Found stale closed PR for $task_id. Incrementing attempts in main tracker."
              
              # ä½¿ç”¨ jq æ›´æ–°ä¸»ç·š tracker.json
              jq --arg id "$task_id" '(.phases[].tasks[] | select(.id == $id)).attempts += 1' .{{AGENT_NAME}}/tracker.json > tmp.json && mv tmp.json .{{AGENT_NAME}}/tracker.json
              
              git config user.name "github-actions"
              git config user.email "github-actions@github.com"
              git add .{{AGENT_NAME}}/tracker.json
              git commit -m "chore: [Arbitrator] task $task_id failed (attempts +1)"
              git push origin {{BASE_BRANCH}}
              
              # ç‰©ç†æ¸…ç†æ­»é–åˆ†æ”¯
              git push origin --delete "$branch"
              echo "âœ… Task $task_id recovered and branch deleted."
            fi
          done
          
    # [!] æ³¨æ„ï¼šæœ¬è…³æœ¬ç‚ºé‚è¼¯ç¯„æœ¬ï¼Œå¯¦éš›é‹ä½œå»ºè­°é…åˆ jq è™•ç† JSONã€‚
