name: {{AGENT_NAME}} Auto-Merge

on:
  pull_request:
    types: [labeled, synchronize, reopened, ready_for_review]
    branches:
      - '{{BASE_BRANCH}}'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # ğŸ•µï¸ å®‰å…¨é–€æˆ¶ (Security Gates)
    # 1. åƒ…é™ BOT_USERNAME è§¸ç™¼
    # 2. å¿…é ˆå…·å‚™ auto-merge æ¨™ç±¤ (Label)
    if: |
      github.event.pull_request.user.login == '{{BOT_USERNAME}}' &&
      contains(github.event.pull_request.labels.*.name, 'auto-merge')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # ğŸ›¡ï¸ Scaffolding Guard: ç¢ºä¿æ—©æœŸ PR ä¸è¢«éœé»˜åˆä½µ
      - name: Basic Factory Audit
        run: |
          if [ ! -f ".{{AGENT_NAME}}/tracker.json" ]; then
            echo "Error: Factory structure not found. Blocking merge."
            exit 1
          fi
          echo "Factory structure verified."

      # CI: å‹•æ…‹åµæ¸¬é˜²è­·æ©Ÿåˆ¶
      - name: Backend Tests (Maven)
        run: |
          if [ -f "./pom.xml" ]; then
            ./mvnw clean test
          elif [ -f "backend/pom.xml" ]; then
            cd backend && ./mvnw clean test
          else
            echo "Backend not initialized yet. Skipping tests."
          fi

      - name: Frontend Checks (NPM)
        run: |
          if [ -f "./package.json" ]; then
            npm install && npm run build
          elif [ -f "frontend/package.json" ]; then
            cd frontend && npm install && npm run build
          else
            echo "Frontend not initialized yet. Skipping checks."
          fi

      - name: Auto-merge PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
          # âš ï¸ ACTION REQUIRED: GITHUB_TOKEN é€šå¸¸ç„¡æ¬Šé™åŸ·è¡Œ auto-merge æˆ–ç¹éåˆ†æ”¯ä¿è­·ã€‚
          # è«‹è‡³ GitHub Repo â†’ Settings â†’ Secrets â†’ Actions æ–°å¢ PAT_TOKENã€‚
          # PAT éœ€è¦çš„æ¬Šé™ï¼šrepo (full), workflowã€‚
          # è¨­å®šå®Œæˆå¾Œï¼Œè«‹ç¢ºä¿æ­¤è™•ä½¿ç”¨çš„æ˜¯ PAT_TOKENã€‚
          token: ${{ secrets.PAT_TOKEN }}
