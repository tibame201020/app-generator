phase: "Phase 2: Core State Machine & Domain Entities"
description: >
  本階段的目標是建構整個 Jules Software Factory 的大腦。包含資料庫的 Schema 設計，
  以及驅動 PM/SA/PG 輪流發言與工作的核心狀態機引擎。

groups:
  - id: "2.1"
    name: "Domain Entities & Database"
    tasks:
      - id: "task_2_1_1"
        title: "建立 Project 與 Conversation JPA Entities (含 Snowflake ID & MinIO)"
        objective: "建立核心領域模型，分離關聯資料與龐大檔案。"
        acceptance_criteria:
          - "實作 Snowflake 演算法的 ID Generator (或引入相關套件)。"
          - "建立 Project entity，ID 採用 Snowflake 生成的 Long/String 模擬 UUID。"
          - "建立 Conversation entity，ID 亦採用 Snowflake 演算法。"
          - "Conversation 欄位設計：包含 content_text (String, 放 Agent 對話) 與 content_file_url (String, 放 MinIO S3 檔案連結)，徹底移除耗費效能的 LONGTEXT 設計。"
          - "執行測試確認 Hibernate schema 自動生成至 H2。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

      - id: "task_2_1_2"
        title: "建立對應的 Spring Data JPA Repositories"
        objective: "實作資料存取層。"
        acceptance_criteria:
          - "建立 ProjectRepository 介面繼承 JpaRepository。"
          - "建立 ConversationRepository 介面，並實作 findByProjectIdOrderByTimestampAsc。"
          - "確保 Repository 能正確處理 Snowflake ID 型別。"
          - "撰寫 @DataJpaTest 驗證 Repository 讀寫。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

  - id: "2.2"
    name: "Core State Machine Engine"
    tasks:
      - id: "task_2_2_1"
        title: "定義 AgentRole Enum 與 State Enum"
        objective: "定義系統靜態常數。"
        acceptance_criteria:
          - "建立 AgentRole Enum (USER, PM, UIUX, SA, PG, SYSTEM)。"
          - "建立 ProjectState Enum (REQUIREMENT_GATHERING, ARCHITECTURE_DESIGN, IMPLEMENTATION, REVIEW)。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

      - id: "task_2_2_2"
        title: "實作 StateMachineEngine 介面與 BaseContext"
        objective: "設計狀態機的控制反轉 (IoC) 介面。"
        acceptance_criteria:
          - "定義 StateMachineEngine interface 包含 processEvent()。"
          - "定義 StateContext record，封裝傳入各節點的 Payload (Project ID, Current Messages)。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

      - id: "task_2_2_3"
        title: "實作 PM 狀態轉移邏輯 (PMState)"
        objective: "實作 PM 階段的處理邏輯。"
        acceptance_criteria:
          - "建立 PMStateHandler 實作處理邏輯。"
          - "決定下一個狀態是待在 REQUIREMENT_GATHERING 或前往 ARCHITECTURE_DESIGN。"
          - "每次狀態推進後，必須立刻呼叫 Repository 的 save() 方法將狀態落入資料庫，確保 Docker 重啟後能接續開發。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

      - id: "task_2_2_4"
        title: "實作 SA 狀態轉移邏輯 (SAState)"
        objective: "實作 SA 階段的處理邏輯。"
        acceptance_criteria:
          - "建立 SAStateHandler 實作處理邏輯。"
          - "確定架構能生成 Dummy JSON 結構取代真實規劃。"
          - "與 PMState 相同，狀態改變時必須立刻 save() 落資料庫。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

      - id: "task_2_2_5"
        title: "實作 Guard 條件 (判斷是否需 User 回應)"
        objective: "實作狀態機中斷點。"
        acceptance_criteria:
          - "實作 Guard 方法：若 ProjectState 等待 User，阻擋 Agent 繼續推進。"
          - "撰寫單元測試驗證阻擋邏輯。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

  - id: "2.3"
    name: "API Endpoints"
    tasks:
      - id: "task_2_3_1"
        title: "實作 ProjectController 與 Chat API"
        objective: "建立前端觸發狀態機的入口點。"
        acceptance_criteria:
          - "建立 ProjectController。"
          - "提供 POST /api/projects 建立新專案。"
          - "提供 POST /api/projects/{id}/chat 接收使用者訊息，並於內部呼叫 StateMachineEngine.processEvent() 啟動或推進工作流。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

  - id: "2.4"
    name: "Documentation"
    tasks:
      - id: "task_2_4_1"
        title: "撰寫 docs/backend/state_machine.md 文件"
        objective: "履行文件承諾。"
        acceptance_criteria:
          - "將 docs/backend/state_machine.md 中的 Placeholder 替換為正式的手冊內容。"
          - "必須包含實際畫出的 Mermaid 流程圖，與實作的 Enum 定義。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"
