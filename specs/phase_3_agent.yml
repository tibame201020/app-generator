phase: "Phase 3: LLM Integration & Workflow"
description: >
  本階段將把 Phase 1 準備好的 Spring AI 與 Message Queue 整合進 Phase 2 的狀態引擎中，
  讓整個虛擬工作室「活起來」。

groups:
  - id: "3.1"
    name: "LLM Integration"
    tasks:
      - id: "task_3_1_1"
        title: "實作 LLMPromptTemplateBuilder"
        objective: "集中管理 System Prompts。"
        acceptance_criteria:
          - "建立 PromptTemplateBuilder class。"
          - "定義 PM 與 SA 的預設 System Prompt。"
          - "能夠將 User Message 結合進歷史對話陣列。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

      - id: "task_3_1_2"
        title: "整合 Spring AI 呼叫至 PM 節點"
        objective: "讓 PM 接上智商。"
        acceptance_criteria:
          - "修改 PMStateHandler，注入 ChatModel。"
          - "實際向 LLM 發送 Payload，並將結果存入 Conversation entity 寫入 H2。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

      - id: "task_3_1_3"
        title: "整合 Spring AI 呼叫至 SA 節點 (強制 JSON 解析)"
        objective: "讓 SA 接上智商並確保產出格式。"
        acceptance_criteria:
          - "修改 SAStateHandler，注入 ChatModel。"
          - "設定 SA 特化的 Prompt。"
          - "強制使用 Spring AI 的 StructuredOutputConverter，要求 LLM 只能回傳嚴格的 JSON 結構，不得包含聊天的 Markdown 前綴或後綴。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

      - id: "task_3_1_4"
        title: "實作 PG 產生程式碼的 File I/O 與 MinIO 上傳服務"
        objective: "將生成的程式碼歸檔並產生 URL 引流。"
        acceptance_criteria:
          - "修改 WorkspaceFileService，實作將程式碼寫入 Docker 掛載的 /workspace/{project_id}/ 路徑功能。"
          - "實作 MinIO 上傳功能：同步將程式碼內容上傳至 MinIO 對應 bucket。"
          - "回傳 MinIO 的 Presigned URL 或是內部 File URL，供前端安全唯讀拉取渲染。"
          - "撰寫單元測試驗證 MinIO 上傳與 File I/O 安全性 (防止 Path Traversal)。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"

  - id: "3.2"
    name: "Agent Communication"
    tasks:
      - id: "task_3_2_1"
        title: "實作 in-memory Agent 廣播與原生 WebSocket Endpoint"
        objective: "讓前端能即時得知 Agent 的內部狀態 (MVP 階段)。"
        acceptance_criteria:
          - "建立 Message Event (包含 agentRole, action, message)。"
          - "在 StateMachineEngine 每次切換 state 或呼叫 LLM 前後，發送 Message。"
          - "在此 MVP 階段，使用 Spring 內建的 ApplicationEventPublisher (in-memory broker) 進行發送與監聽。"
          - "後端實作一組原生的 TextWebSocketHandler 掛載於 /ws/agents/{project_id} 供前端連線。"
          - "在實作 WebSocketConfigurer 註冊 Handler 時，強制作為防護線，必須加上 .setAllowedOrigins(\"*\")，以防止 Vite 代理時遭到 403 Origin Forbidden 攔截。"
          - "嚴禁引入 @EnableWebSocketMessageBroker 與 STOMP/SockJS，避免前後端連線協定不對等而失敗。"
          - "更新 CHANGELOG.md 並將 .jules/tracker.json 中對應 task 標為 completed。"
